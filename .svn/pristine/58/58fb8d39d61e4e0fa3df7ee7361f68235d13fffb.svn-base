<?php include('lib/config.php');

$t = time();
//$data = 'HashKey=SZiHER7CA7NTODXxA0y8gnwaApxzp8eh' .
//    '&Amt=200' .
//    '&MerchantID=316120815' .
//    '&MerchantOrderNo=' . $mid .
//    '&TimeStamp=' . $t .
//    '&Version=1.2' .
//    '&HashIV=8xZMo6oZecS2PQAq';
$data = 'HashIV=8xZMo6oZecS2PQAq' .
    '&Amt=200' .
    '&MerchantID=316120815' .
    '&MerchantOrderNo=' . $mid .
    '&TimeStamp=' . $t .
    '&Version=1.2' .
    '&HashKey=SZiHER7CA7NTODXxA0y8gnwaApxzp8eh';

// 用PHP 內建的 hash() SHA256 編碼後再轉成大寫
//var_dump($data);
$checkValue = strtoupper(hash('sha256', $data));
//var_dump(hash('sha256', $data));
//var_dump(hash('sha256', $data));
$check_code = array(
    "MerchantID" => $pay2go_setting['MerchantID'],
    "Amt" => '100',
    "MerchantOrderNo" => $mid,
//    "TradeNo" => '14061313541640927',
    "TimeStamp" => $t,
    "Version" => '1.2',
);

/**
 * 將回傳資料其中的四個欄位，分別是 Amt(金額)、MerchantID(商店代號)、
MerchantOrderNo(商店訂單編號)、TradeNo(智付寶交易序號)，且參數需照英文字
母 A~Z 排序，若第一字母相同比較第二字母，以此類推。
 *
 */
ksort($check_code);
$check_str = http_build_query($check_code);
//var_dump($check_str);
$CheckCode = "HashIV=8xZMo6oZecS2PQAq&$check_str&HashKey=SZiHER7CA7NTODXxA0y8gnwaApxzp8eh";
var_dump($CheckCode);
$CheckCode = strtoupper(hash("sha256", $CheckCode));


//var_dump($checkValue);
var_dump($CheckCode);

$pay2go_item =[];

//card_deposit.php?m=pay2goInit&item_id=1
?>
<?php include('lib/pay2go_inc.php'); ?>
<?php include('func/func_card_deposit.php'); ?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf8">
    <link rel="stylesheet" href="css/reset.css">
    <style type="text/css">
        @font-face {
            font-family: 'Noto Sans TC';
            src: url(font/NotoSansTC-Regular.otf);
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            background-image: url("img/star_background4.jpg");
            background-size: cover;
            background-position: 50% 50%;
        }

        form {
            padding-top: 50px;
            margin: auto;
            width: 315px;
            text-align: center;
        }

        td {
            padding: 5px;
            color: #fff;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 15px;
        }

        input[type="text"] {
            padding: 5px;
            width: 200px;
            font-family: 'Noto Sans TC', sans-serif;
            letter-spacing: 1px;
            font-size: 15px;
        }

        input[type="button"],
        input[type="reset"] {
            -moz-box-shadow: inset 0px 1px 0px 0px #97c4fe;
            -webkit-box-shadow: inset 0px 1px 0px 0px #97c4fe;
            box-shadow: inset 0px 1px 0px 0px #97c4fe;
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0.05, #3d94f6), color-stop(1, #1e62d0));
            background: -moz-linear-gradient(top, #3d94f6 5%, #1e62d0 100%);
            background: -webkit-linear-gradient(top, #3d94f6 5%, #1e62d0 100%);
            background: -o-linear-gradient(top, #3d94f6 5%, #1e62d0 100%);
            background: -ms-linear-gradient(top, #3d94f6 5%, #1e62d0 100%);
            background: linear-gradient(to bottom, #3d94f6 5%, #1e62d0 100%);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#3d94f6', endColorstr='#1e62d0', GradientType=0);
            background-color: #3d94f6;
            -moz-border-radius: 6px;
            -webkit-border-radius: 6px;
            border-radius: 6px;
            border: 1px solid #337fed;
            display: inline-block;
            cursor: pointer;
            color: #ffffff;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 15px;
            font-weight: bold;
            padding: 6px 24px;
            text-decoration: none;
            text-shadow: 0px 1px 0px #1570cd;
            margin: 0px 10px;
            letter-spacing: 2px;
        }

        input[type="button"]:hover,
        input[type="reset"]:hover {
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0.05, #1e62d0), color-stop(1, #3d94f6));
            background: -moz-linear-gradient(top, #1e62d0 5%, #3d94f6 100%);
            background: -webkit-linear-gradient(top, #1e62d0 5%, #3d94f6 100%);
            background: -o-linear-gradient(top, #1e62d0 5%, #3d94f6 100%);
            background: -ms-linear-gradient(top, #1e62d0 5%, #3d94f6 100%);
            background: linear-gradient(to bottom, #1e62d0 5%, #3d94f6 100%);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#1e62d0', endColorstr='#3d94f6', GradientType=0);
            background-color: #1e62d0;
        }

        input[type="button"]:active,
        input[type="reset"]:active {
            position: relative;
            top: 1px;
        }

        #butSubmit {
            margin-top: 20px;
        }
    </style>
    <script src="js/jquery-3.1.0.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script>
        $(document).ready(function () {
            //$(".colorbox").colorbox({iframe:true,width:"80%",height:"80%",href:"card_deposit.php"});
            $('#butSubmit').click(function () {

                var carno = $('#carno').val();
                var cardpass = $('#cardpass').val();

                if (carno == '') {
                    alert('請輸入卡號');
                    return false;
                }

                if (cardpass == '') {
                    alert('請輸入卡片密碼');
                    return false;
                }

                if (carno.length != 15) {
                    alert('卡號長度需15碼');
                    return false;
                }

                if (cardpass.length != 20) {
                    alert('卡片密碼長度需20碼');
                    return false;
                }

                $('#form1').attr('action', 'card_deposit.php?m=deposit');
                $('#form1').submit();
            });

        });
    </script>
</head>
<body>
<div>
    <form method="post" action="https://api.pay2go.com/MPG/mpg_gateway">             <!-- 測試環境用的網址 正式的不一樣請注意 -->
        <input type="hidden" name="MerchantID" value="<?= $pay2go_setting['MerchantID'] ?>">            <!-- 店家代號 -->
        <input type="hidden" name="RespondType" value="<?= $pay2go_setting['RespondType'] ?>"/>
        <!-- 回傳資料的格式 -->
        <input type="hidden" name="CheckValue" value="<?php echo $CheckCode; ?>">     <!-- 驗證資料是否一致 -->
        <input type="hidden" name="TimeStamp" value="<?php echo $t; ?>">               <!-- 訂單產生時間 -->
        <input type="hidden" name="Version" value="<?= $pay2go_setting['Version'] ?>">
        <!-- api 版本 請看最新版說明文件 -->
        <input type="hidden" name="LangType" value="<?= $pay2go_setting['LangType'] ?>">               <!-- 訂單產生時間 -->
        <input type="hidden" name="MerchantOrderNo" value="<?php echo $mid; ?>">   <!-- 店家產生的訂單編號 不可重覆 -->
        <input type="hidden" name="Amt" value="<?= $pay2go_item['Amt'] ?>">                    <!-- 商品價格 -->
        <input type="hidden" name="ItemDesc" value="<?= $pay2go_item['ItemDesc'] ?>">
        <!-- 商品名稱 -->
        <input type="hidden" name="TradeLimit" value="<?= $pay2go_setting['TradeLimit'] ?>">
        <!-- 限制交易的秒數，當秒數倒數至 0 時，交易當做失敗 -->
        <input type="hidden" name="ExpireDate" value="60">
        <!-- (適用於非即時交易)格式為 date('Ymd') ，例：20140620 2.此參數若為空值，系統預設為 7 天 -->
        <input type="hidden" name="ExpireTime" value="60">
        <!-- 1.僅適用於超商代碼繳費 2.格式為 date('His') ，例：235959 -->
        <input type="hidden" name="ReturnURL" value="">                   <!--交易完成後，以 Form Post 方式導回商店頁面 -->
        <input type="hidden" name="NotifyURL" value="">                   <!--以幕後方式回傳給商店相關支付結果資料 -->
        <input type="hidden" name="CustomerURL" value="">
        <!--.系統取號後以 form post 方式將結果導回商店指定的網址，請參考 七、取號完成系統回傳參數說明。 -->
        <input type="hidden" name="ClientBackURL" value="">
        <!--交易取消時，平台會出現返回鈕，使消費者依以此參數網址返回商店指定的頁面 -->
        <input type="hidden" name="Email" value="test@gmail.com">                   <!-- 付款成功會寄通知信到這個email -->
        <input type="hidden" name="EmailModify" value="1">                   <!-- 可以在致富保頁面修改email -->
        <input type="hidden" name="LoginType" value="0"><!-- 是否需要登入智付寶會員才能付款 0 不用 1 要，廢話這一定要填0的丫 -->
        <input type="hidden" name="OrderComment" value="TEST OrderComment"><!-- 將會於 MPG 頁面呈現商店備註內容。 -->
        <button type="submit">付款</button>
</div>
</body>
</html>